apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubernetes-dashboard
spec:
  interval: 1h
  chart:
    spec:
      chart: kubernetes-dashboard
      version: 6.0.8
      sourceRef:
        kind: HelmRepository
        name: kubernetes-dashboard
        namespace: flux-system
  maxHistory: 2
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    protocolHttp: true
    extraArgs:
    - --enable-insecure-login
        
---
---
apiVersion: v1
kind: Service
metadata:
  name: kube-dash
  annotations:
    external-dns.alpha.kubernetes.io/hostname: kube-dash.internal
spec:
  ports:
  - name: http
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app.kubernetes.io/component: kubernetes-dashboard
    app.kubernetes.io/instance: kubernetes-dashboard
    app.kubernetes.io/name: kubernetes-dashboard
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: external-auth-oauth2
  annotations:
    nginx.ingress.kubernetes.io/auth-url: "https://$host/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "http://$host/oauth2/start?rd=$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "authorization"
spec:
  ingressClassName: nginx-external
  rules:
  - host: &host kubernetes-dashboard.local.icylair.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kube-dash
            port:
              number: 9090
  tls:
  - hosts:
    - *host
    secretName: icylair-com-all-prod