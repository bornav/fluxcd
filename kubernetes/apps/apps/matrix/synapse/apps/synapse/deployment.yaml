---
# yaml-language-server: $schema=https://raw.githubusercontent.com/instrumenta/kubernetes-json-schema/master/v1.14.0/deployment.json
apiVersion: apps/v1
kind: Deployment
metadata:
  name: matrix-synapse
  labels:
    app: matrix-synapse
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: matrix-synapse
  template:
    metadata:
      annotations:
        prometheus.io/path: /_synapse/metrics
        prometheus.io/port: '9090'
        prometheus.io/scrape: 'true'
      labels:
        app: matrix-synapse
    spec:
      nodeSelector:
        node-arch: arm64
      # shareProcessNamespace: true
      initContainers:
        - name: grab-scripts
          image: mrnonz/alpine-git-curl:alpine3.16
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              cd scripts
              git clone --branch v1.5.0 https://github.com/matrix-org/synapse-s3-storage-provider.git
          volumeMounts:
            - mountPath: /scripts
              name: scripts
      containers:
        - image: matrixdotorg/synapse:v1.135.2
          name: matrix-synapse
          command:
            - sh
            - -c
            # - sleep infinity
            - | 
              ./start.py generate
              curl https://raw.githubusercontent.com/devture/matrix-synapse-shared-secret-auth/master/shared_secret_authenticator.py -o  /usr/local/lib/python$(python --version|cut -d' ' -f2- | cut -d'.' -f1-2)/shared_secret_authenticator.py
              pip install boto3
              export PYTHONPATH=$PYTHONPATH:/scripts/synapse-s3-storage-provider/
              ./start.py
          ports:
          - name: http
            protocol: TCP
            containerPort: 8008
          - name: https
            protocol: TCP
            containerPort: 8448
          - name: replication
            protocol: TCP
            containerPort: 9092
          - name: httpreplication
            protocol: TCP
            containerPort: 9093
          env:
            - name: SYNAPSE_CACHE_FACTOR # overwrites config file
              value: '5.00'
            - name: SYNAPSE_CONFIG_PATH
              value: '/synapse/homeserver.yaml'
            - name: SYNAPSE_SERVER_NAME
              value: 'matrix.icylair.com'
            - name: SYNAPSE_REPORT_STATS
              value: 'no'
          imagePullPolicy: IfNotPresent
          # livenessProbe:
          #   httpGet:
          #     path: /_matrix/client/versions
          #     port: 8008
          #     scheme: HTTP
          #   initialDelaySeconds: 120
          # readinessProbe:
          #   httpGet:
          #     path: /_matrix/client/versions
          #     port: 8008
          #     scheme: HTTP
          #   initialDelaySeconds: 10
          resources:
            requests:
              memory: '1Mi'
              cpu: '1m'
            limits:
              memory: '6Gi'
          volumeMounts:
            - mountPath: /scripts
              name: scripts
            - mountPath: /data
              name: matrix-synapse-data
            - mountPath: /synapse/homeserver.yaml
              name: matrix-synapse-config
              subPath: homeserver
            - mountPath: /synapse/bridge_whatsapp.yaml
              name: matrix-synapse-config
              subPath: bridge_whatsapp
            - mountPath: /synapse/bridge_meta.yaml
              name: matrix-synapse-config
              subPath: bridge_meta
            - mountPath: /synapse/doublepuppet.yaml
              name: matrix-synapse-config
              subPath: doublepuppet
        - image: matrixdotorg/synapse:v1.135.2
          name: s3-upload-missing
          command:
            - sh
            - -c
            - | 
              pip install boto3 humanize tqdm
              cd /scripts/synapse-s3-storage-provider/scripts
              while true; do sleep 10m; echo "checking if local files are missing on s3"; ./s3_media_upload update-db --homeserver-config-path /synapse/homeserver.yaml 0d && ./s3_media_upload check-deleted /data/media_store/ && ./s3_media_upload upload /data/media_store/ matrix --endpoint-url http://wireguard.network.svc.cluster.local:9010 --prefix synapse/; done
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: aws-credentials
          resources:
            requests:
              memory: '1Mi'
              cpu: '1m'
            limits:
              memory: '1Gi'
          volumeMounts:
            - mountPath: /scripts
              name: scripts
            - mountPath: /synapse/homeserver.yaml
              name: matrix-synapse-config
              subPath: homeserver
            - mountPath: /data
              name: matrix-synapse-data
      restartPolicy: Always
      securityContext:
        fsGroup: 0
        runAsGroup: 0
        runAsUser: 0
      volumes:
        - name: scripts
          emptyDir: {}
        - name: matrix-synapse-data
          emptyDir: {}
        - name: matrix-synapse-config
          configMap:
            name: matrix-synapse
            defaultMode: 0777
        - name: matrix-synapse-bridges
          configMap:
            name: matrix-synapse-bridges
            defaultMode: 0777
status: {}
#to get the key "curl -XPOST -d '{"type":"m.login.password","identifier":{"type": "m.id.user", "user": "<username>"},"password":"<pass>","initial_device_display_name":"a fancy bridge"}' https://matrix.cloud.icylair.com/_matrix/client/v3/login"