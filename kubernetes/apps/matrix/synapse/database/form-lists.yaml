apiVersion: batch/v1
kind: Job
metadata:
    name: create-db-job
spec:
    template:
        spec:
            containers:
                - name: check-db-container
                  image: postgres
                  env:
                    - name: DB_HOST
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_HOST
                    - name: DB_USER
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER
                  command:
                    - /bin/bash
                    - -c
                  args:
                    - while ! pg_isready -h $DB_HOST -U $DB_USER > /dev/null 2>&1; do sleep 1; done
                - name: create-db-container-synapse
                  image: postgres
                  env:
                    - name: DB_HOST
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_HOST
                    - name: DB_USER
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER
                    - name: DB_ENCODING
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_ENCODING
                    - name: DB_LOCALE
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_LOCALE
                    - name: DB_TEMPLATE
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_TEMPLATE
                    - name: DB_NAME
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_NAME_SYNAPSE
                    - name: DB_USER_NAME
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER_NAME_SYNAPSE
                    - name: DB_USER_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER_PASSWORD
                    - name: POSTGRES_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: POSTGRES_PASSWORD
                  command:
                    - /bin/bash
                    - -c
                  args:
                    - if ! PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c 'select 1' > /dev/null 2>&1; then PGPASSWORD=$POSTGRES_PASSWORD createdb -h $DB_HOST --username=$DB_USER --encoding=$DB_ENCODING --locale=$DB_LOCALE --template=$DB_TEMPLATE $DB_NAME && PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $DB_USER -c "CREATE USER $DB_USER_NAME WITH PASSWORD '$DB_USER_PASSWORD'; GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER_NAME;"; fi
                - name: create-db-container-facebook
                  image: postgres
                  env:
                    - name: DB_HOST
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_HOST
                    - name: DB_USER
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER
                    - name: DB_ENCODING
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_ENCODING
                    - name: DB_LOCALE
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_LOCALE
                    - name: DB_TEMPLATE
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_TEMPLATE
                    - name: DB_NAME
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_NAME_FACEBOOK
                    - name: DB_USER_NAME
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER_NAME_FACEBOOK
                    - name: DB_USER_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER_PASSWORD
                    - name: POSTGRES_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: POSTGRES_PASSWORD
                  command:
                    - /bin/bash
                    - -c
                  args:
                    - if ! PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c 'select 1' > /dev/null 2>&1; then PGPASSWORD=$POSTGRES_PASSWORD createdb -h $DB_HOST --username=$DB_USER --encoding=$DB_ENCODING --locale=$DB_LOCALE --template=$DB_TEMPLATE $DB_NAME && PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $DB_USER -c "CREATE USER $DB_USER_NAME WITH PASSWORD '$DB_USER_PASSWORD'; GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER_NAME;"; fi
                - name: create-db-container-whatsapp
                  image: postgres
                  env:
                    - name: DB_HOST
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_HOST
                    - name: DB_USER
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER
                    - name: DB_ENCODING
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_ENCODING
                    - name: DB_LOCALE
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_LOCALE
                    - name: DB_TEMPLATE
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_TEMPLATE
                    - name: DB_NAME
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_NAME_WHATSAPP
                    - name: DB_USER_NAME
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER_NAME_WHATSAPP
                    - name: DB_USER_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER_PASSWORD
                    - name: POSTGRES_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: POSTGRES_PASSWORD
                  command:
                    - /bin/bash
                    - -c
                  args:
                    - if ! PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c 'select 1' > /dev/null 2>&1; then PGPASSWORD=$POSTGRES_PASSWORD createdb -h $DB_HOST --username=$DB_USER --encoding=$DB_ENCODING --locale=$DB_LOCALE --template=$DB_TEMPLATE $DB_NAME && PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $DB_USER -c "CREATE USER $DB_USER_NAME WITH PASSWORD '$DB_USER_PASSWORD'; GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER_NAME;"; fi
                - name: create-db-container-telegram
                  image: postgres
                  env:
                    - name: DB_HOST
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_HOST
                    - name: DB_USER
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER
                    - name: DB_ENCODING
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_ENCODING
                    - name: DB_LOCALE
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_LOCALE
                    - name: DB_TEMPLATE
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_TEMPLATE
                    - name: DB_NAME
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_NAME_TELEGRAM
                    - name: DB_USER_NAME
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER_NAME_TELEGRAM
                    - name: DB_USER_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: DB_USER_PASSWORD
                    - name: POSTGRES_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: synapse-database-secrets
                          key: POSTGRES_PASSWORD
                  command:
                    - /bin/bash
                    - -c
                  args:
                    - if ! PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c 'select 1' > /dev/null 2>&1; then PGPASSWORD=$POSTGRES_PASSWORD createdb -h $DB_HOST --username=$DB_USER --encoding=$DB_ENCODING --locale=$DB_LOCALE --template=$DB_TEMPLATE $DB_NAME && PGPASSWORD=$POSTGRES_PASSWORD psql -h $DB_HOST -U $DB_USER -c "CREATE USER $DB_USER_NAME WITH PASSWORD '$DB_USER_PASSWORD'; GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER_NAME;"; fi
            restartPolicy: OnFailure
    backoffLimit: 10
